<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Desert Ridge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/mapbox/assembly/publisher-staging/src/svgs/mapbox.svg">
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/intersection-observer@0.12.0/intersection-observer.js"></script>
  <script src="https://unpkg.com/scrollama"></script>
  <style>
    :root{ --step-max:760px; --step-pad-x:50px; --step-pad-y:25px; }
    body{ margin:0; padding:0; font-family:Georgia,"Times New Roman",serif; }
    a,a:hover,a:visited{ color:#0071bc; }
    #map{ top:0; height:100vh; width:100vw; position:fixed; }
    #mapInset{ bottom:50px; right:30px; height:180px; width:250px; max-width:100%; position:fixed; z-index:1; opacity:1; transition:opacity .5s ease-in-out; pointer-events:none; }
    #mapInset .mapboxgl-ctrl-bottom-left{ display:none; }
    #header{ margin:auto; width:100%; position:relative; z-index:5; }
    #header h1,#header h2,#header p{ margin:0; padding:2vh 2vw; text-align:center; }
    #footer{ width:100%; min-height:5vh; padding-top:2vh; padding-bottom:2vh; text-align:center; line-height:25px; font-size:13px; position:relative; z-index:5; }
    #features{ padding-top:10vh; padding-bottom:10vh; }
    .hidden{ visibility:hidden; }
    .centered{ width:50vw; margin:0 auto; }
    .lefty{ width:33vw; margin-left:5vw; }
    .righty{ width:33vw; margin-left:62vw; }
    .fully{ width:100%; margin:auto; }
    .light{ color:#ee4800; background:#fafafa; }
    .dark{ color:#191919; background:#fafafa; opacity:.9; }
    .step{ padding-bottom:50vh; opacity:.25; }
    .step.active{ opacity:.9; }
    .step div{
      padding:var(--step-pad-y) var(--step-pad-x);
      line-height:1.8; font-size:18px; max-width:var(--step-max);
      background:rgba(255,255,255,.9);
      border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,.08);
    }
    .step img{ width:100%; }
    .step h3{ font-size:22px; font-weight:bold; }

    .mapboxgl-popup{ opacity:1!important; transition:none!important; max-width:300px; font-family:"Helvetica Neue",Arial,sans-serif; }
    .mapboxgl-popup-content{ padding:12px 16px; font-size:14px; line-height:1.4; background:#fff; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,.15); }
    .mapboxgl-popup-content h4,.mapboxgl-popup-content strong{ margin:0 0 6px; font-size:15px; color:#25408f; }
    .mapboxgl-popup-content p{ margin:0; color:#444; }
    .mapboxgl-popup-tip{ display:none!important; }

    .poi-marker{ pointer-events:auto; }
    .poi-dot{
      width:20px; height:20px; background:#e11d48; border:2px solid #fff; border-radius:50%;
      box-shadow:0 0 6px rgba(0,0,0,.25); cursor:pointer;
      transition:transform .12s ease, background-color .12s ease, box-shadow .12s ease;
    }
    .poi-dot:hover{ transform:scale(1.35); background:#be123c; box-shadow:0 0 10px rgba(0,0,0,.4); }
    .poi-dot.blue{ width:25px; height:25px; background:#2563eb; border:2px solid #fff; border-radius:50%; box-shadow:0 0 6px rgba(0,0,0,.25); }
    .poi-marker:hover .poi-dot.blue{ transform:scale(1.3); background:#1e40af; }
    .poi-dot.circled{
      box-shadow:0 0 0 5px rgba(255,59,48,.95),0 0 10px rgba(0,0,0,.55),0 0 18px rgba(255,59,48,.85);
      border-radius:50%; z-index:20;
    }

    @media (max-width:1024px){
      .lefty,.righty,.centered{ width:86vw; margin-left:7vw; margin-right:7vw; }
      :root{ --step-max:820px; --step-pad-x:32px; --step-pad-y:20px; }
      .step div{ font-size:17px; }
    }
    @media (max-width:600px){
      #mapInset{ display:none; }
      .lefty,.righty,.centered{ width:92vw; margin-left:4vw; margin-right:4vw; }
      :root{ --step-max:700px; --step-pad-x:18px; --step-pad-y:16px; }
      .step div{ font-size:16px; line-height:1.65; }
      .step{ padding-bottom:45vh; }
      .poi-dot{ width:14px; height:14px; }
      .poi-dot.blue{ width:18px; height:18px; }
      #header h1{ font-size:26px; }
      #header h2{ font-size:18px; }
    }
    @media (min-width:1400px){
      .poi-dot{ width:22px; height:22px; }
      .poi-dot.blue{ width:28px; height:28px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="mapInset"></div>
  <div id="story"></div>

  <!-- config.js must define: accessToken, style, projection, inset, auto, showMarkers, chapters[] -->
  <script src="./config.js"></script>

  <script>
  // -------- Responsive helpers (ES5) --------
  var BP = { mobile:600, tablet:1024 };
  function isMobile(){ return window.innerWidth <= BP.mobile; }
  function isTablet(){ return window.innerWidth > BP.mobile && window.innerWidth <= BP.tablet; }
  function clone(obj){ return JSON.parse(JSON.stringify(obj)); }

  function resolveChapterLocation(chapter){
    if (isMobile() && chapter.locationMobile){ return clone(chapter.locationMobile); }
    if (isTablet() && chapter.locationTablet){ return clone(chapter.locationTablet); }
    var base = clone(chapter.location);
    var dz = isMobile() ? -1.6 : (isTablet() ? -0.8 : 0);
    if (typeof base.zoom === "number"){ base.zoom = Math.max(3, base.zoom + dz); }
    return base;
  }

  function computeAllSitesBounds(geojson){
    var bbox = [[Infinity,Infinity],[-Infinity,-Infinity]];
    function extend(c){ var lng=c[0], lat=c[1];
      if(lng<bbox[0][0])bbox[0][0]=lng; if(lat<bbox[0][1])bbox[0][1]=lat;
      if(lng>bbox[1][0])bbox[1][0]=lng; if(lat>bbox[1][1])bbox[1][1]=lat;
    }
    var i,j,k,f,geom,t;
    for(i=0;i<geojson.features.length;i++){
      f=geojson.features[i]; geom=f.geometry; if(!geom) continue; t=geom.type;
      if(t==="Point"){ extend(geom.coordinates); }
      else if(t==="LineString"){ for(j=0;j<geom.coordinates.length;j++) extend(geom.coordinates[j]); }
      else if(t==="Polygon"){
        for(j=0;j<geom.coordinates.length;j++){ for(k=0;k<geom.coordinates[j].length;k++) extend(geom.coordinates[j][k]); }
      }
      else if(t==="MultiPolygon"){
        for(j=0;j<geom.coordinates.length;j++){ for(k=0;k<geom.coordinates[j].length;k++){ var r=geom.coordinates[j][k], m; for(m=0;m<r.length;m++) extend(r[m]); } }
      }
      else if(t==="MultiLineString"){ for(j=0;j<geom.coordinates.length;j++){ for(k=0;k<geom.coordinates[j].length;k++) extend(geom.coordinates[j][k]); } }
      else if(t==="MultiPoint"){ for(j=0;j<geom.coordinates.length;j++) extend(geom.coordinates[j]); }
    }
    if (bbox[0][0]===Infinity){ return null; }
    return bbox;
  }

  // -------- Base scaffolding --------
  var initLoad = true;
  var alignments = { "left":"lefty", "center":"centered", "right":"righty", "full":"fully" };
  var layerTypes = {
    "fill":["fill-opacity"], "line":["line-opacity"],
    "circle":["circle-opacity","circle-stroke-opacity"],
    "symbol":["icon-opacity","text-opacity"], "raster":["raster-opacity"],
    "fill-extrusion":["fill-extrusion-opacity"], "heatmap":["heatmap-opacity"]
  };

  var story = document.getElementById("story");
  var features = document.createElement("div");
  features.setAttribute("id","features");

  var header = document.createElement("div");
  if (config.title){ var h1=document.createElement("h1"); h1.innerText=config.title; header.appendChild(h1); }
  if (config.subtitle){ var h2=document.createElement("h2"); h2.innerText=config.subtitle; header.appendChild(h2); }
  if (config.byline){ var by=document.createElement("p"); by.innerText=config.byline; header.appendChild(by); }
  if (header.innerText.length>0){ header.classList.add(config.theme); header.setAttribute("id","header"); story.appendChild(header); }

  var i;
  for (i=0;i<config.chapters.length;i++){
    var record = config.chapters[i];
    var container = document.createElement("div");
    var chapter = document.createElement("div");

    if (record.title){ var t=document.createElement("h3"); t.innerHTML=record.title; chapter.appendChild(t); }
    if (record.image){ var im=new Image(); im.src=record.image; chapter.appendChild(im); }
    if (record.description){ var p=document.createElement("p"); p.innerHTML=record.description; chapter.appendChild(p); }

    container.setAttribute("id",record.id);
    container.classList.add("step");
    if (i===0){ container.classList.add("active"); }

    chapter.classList.add(config.theme);
    container.appendChild(chapter);
    container.classList.add(alignments[record.alignment]||"centered");
    if (record.hidden){ container.classList.add("hidden"); }
    features.appendChild(container);
  }
  story.appendChild(features);

  var footer = document.createElement("div");
  if (config.footer){ var ft=document.createElement("p"); ft.innerHTML=config.footer; footer.appendChild(ft); }
  if (footer.innerText.length>0){ footer.classList.add(config.theme); footer.setAttribute("id","footer"); story.appendChild(footer); }

  mapboxgl.accessToken = config.accessToken;
  function transformRequest(url){
    var hasQuery=url.indexOf("?")!==-1;
    var suffix=hasQuery?"&pluginName=scrollytellingV2":"?pluginName=scrollytellingV2";
    return { url:url+suffix };
  }

  var firstLoc = resolveChapterLocation(config.chapters[0]);
  var map = new mapboxgl.Map({
    container:"map",
    style:config.style,
    center:firstLoc.center,
    zoom:firstLoc.zoom,
    bearing:firstLoc.bearing,
    pitch:firstLoc.pitch,
    interactive:false,
    transformRequest:transformRequest,
    projection:config.projection
  });

  // Turn map interactions on/off
function setMapInteractive(on) {
  var m = map;
  var canvas = m.getCanvas ? m.getCanvas() : null;

  if (on) {
    if (m.scrollZoom && m.scrollZoom.enable) m.scrollZoom.enable();
    if (m.boxZoom && m.boxZoom.enable) m.boxZoom.enable();
    if (m.dragRotate && m.dragRotate.enable) m.dragRotate.enable();
    if (m.dragPan && m.dragPan.enable) m.dragPan.enable();
    if (m.keyboard && m.keyboard.enable) m.keyboard.enable();
    if (m.doubleClickZoom && m.doubleClickZoom.enable) m.doubleClickZoom.enable();
    if (m.touchZoomRotate && m.touchZoomRotate.enable) m.touchZoomRotate.enable();
    if (canvas) canvas.style.cursor = 'grab';
  } else {
    if (m.scrollZoom && m.scrollZoom.disable) m.scrollZoom.disable();
    if (m.boxZoom && m.boxZoom.disable) m.boxZoom.disable();
    if (m.dragRotate && m.dragRotate.disable) m.dragRotate.disable();
    if (m.dragPan && m.dragPan.disable) m.dragPan.disable();
    if (m.keyboard && m.keyboard.disable) m.keyboard.disable();
    if (m.doubleClickZoom && m.doubleClickZoom.disable) m.doubleClickZoom.disable();
    if (m.touchZoomRotate && m.touchZoomRotate.disable) m.touchZoomRotate.disable();
    if (canvas) canvas.style.cursor = '';
  }
}

// Start with interactions OFF
setMapInteractive(false);


  var insetMap=null;
  if (config.inset){
    insetMap = new mapboxgl.Map({
      container:"mapInset",
      style:"mapbox://styles/mapbox/dark-v10",
      center:firstLoc.center,
      zoom:3, hash:false, interactive:false, attributionControl:false
    });
  }

  var marker=null;
  if (config.showMarkers){
    marker = new mapboxgl.Marker({ color:config.markerColor });
    marker.setLngLat(firstLoc.center).addTo(map);
  }

  var dotsByKey = {};
  var hoverPopup = new mapboxgl.Popup({ closeButton:false, closeOnClick:false, closeOnMove:true, offset:12 });
  var hoverTimer=null;
  function showHoverPopup(lngLat, html){
    clearTimeout(hoverTimer);
    hoverTimer=setTimeout(function(){
      hoverPopup.setLngLat(lngLat).setHTML(html);
      if (!hoverPopup.isOpen()){ hoverPopup.addTo(map); }
    },60);
  }
  function hideHoverPopup(){ clearTimeout(hoverTimer); if(hoverPopup.isOpen()) hoverPopup.remove(); }

  var sitesFC_cache=null;
  var didInitialMobileFit=false;

  function getLayerPaintType(layer){ return layerTypes[ map.getLayer(layer).type ]; }
  function setLayerOpacity(layer){
    var props=getLayerPaintType(layer.layer), idx;
    for (idx=0; idx<props.length; idx++){
      var prop=props[idx], options={};
      if (layer.duration){
        var tprop=prop+"-transition"; options={ "duration":layer.duration };
        map.setPaintProperty(layer.layer, tprop, options);
      }
      map.setPaintProperty(layer.layer, prop, layer.opacity, options);
    }
  }

  map.on("load", function(){

    // Focus circles
    map.addSource("focus-circles",{ type:"geojson", data:{ type:"FeatureCollection", features:[] } });
    map.addLayer({
      id:"focus-circles-fill", type:"circle", source:"focus-circles",
      paint:{ "circle-radius":["interpolate",["linear"],["zoom"],12,80,14,140,16,220],
              "circle-color":"rgba(59,130,246,.18)","circle-blur":0.2 },
      layout:{ visibility:"none" }
    });
    map.addLayer({
      id:"focus-circles-outline", type:"circle", source:"focus-circles",
      paint:{ "circle-radius":["interpolate",["linear"],["zoom"],12,80,14,140,16,220],
              "circle-color":"rgba(0,0,0,0)","circle-stroke-color":"#3b82f6","circle-stroke-width":3 },
      layout:{ visibility:"none" }
    });
    function setFocusCircles(coords){
      var feats=[], i; if(coords){ for(i=0;i<coords.length;i++){ feats.push({type:"Feature",properties:{},geometry:{type:"Point",coordinates:coords[i]}}); } }
      map.getSource("focus-circles").setData({ type:"FeatureCollection", features:feats });
      map.setLayoutProperty("focus-circles-fill","visibility","visible");
      map.setLayoutProperty("focus-circles-outline","visibility","visible");
    }
    function hideFocusCircles(){
      map.setLayoutProperty("focus-circles-fill","visibility","none");
      map.setLayoutProperty("focus-circles-outline","visibility","none");
    }

    if (config.use3dTerrain){
      map.addSource("mapbox-dem",{ type:"raster-dem", url:"mapbox://mapbox.mapbox-terrain-dem-v1", tileSize:512, maxzoom:14 });
      map.setTerrain({ source:"mapbox-dem", exaggeration:1.5 });
      map.addLayer({ id:"sky", type:"sky", paint:{ "sky-type":"atmosphere","sky-atmosphere-sun":[0,0],"sky-atmosphere-sun-intensity":15 } });
    }

    if (config.inset){ map.on("move", getInsetBounds); }

    // ---------- Your GeoJSON ----------
    var sitesFC = {"type":"FeatureCollection","features":[
      {"type":"Feature","properties":{"name":"Sprouts Corporate HQs","desc":"Completing Q2 2026"},"geometry":{"type":"Polygon","coordinates":[[
        [-111.96221286389077,33.67412096001901],[-111.96214484697303,33.672635092311964],
        [-111.96032539442032,33.67269169726629],[-111.96042741979727,33.674163413004734],
        [-111.96221286389077,33.67412096001901]
      ]]}},
      {"type":"Feature","properties":{"name":"AC Hotel by Marriott","desc":"Delivering in early 2027"},"geometry":{"type":"Polygon","coordinates":[[
        [-111.96222986812055,33.67502661917112],[-111.96221286389077,33.67440397952868],
        [-111.96035940287919,33.674446432374694],[-111.96035940287919,33.67508322255131],
        [-111.96222986812055,33.67502661917112]
      ]]}},
      {"type":"Feature","properties":{"name":"Republic Services","desc":"Completing Q4 2025"},"geometry":{"type":"Polygon","coordinates":[[
        [-111.96977188569741,33.67372781357136],[-111.97006598731089,33.67310651309653],
        [-111.9668421811621,33.67185448486805],[-111.9665480795486,33.672635827930705],
        [-111.96977188569741,33.67372781357136]
      ]]}},
      {"type":"Feature","properties":{"name":"Trace Line","desc":"Example line"},"geometry":{"type":"LineString","coordinates":[
        [-111.90654113044617,33.6619780119872],[-111.90802771231205,33.65884911257095],
        [-111.90833528097372,33.655279183822955],[-111.9159390617823,33.65677259833025],
        [-111.91535809875606,33.65954601365448],[-111.91572293699305,33.66191268268466],
        [-111.90938360512793,33.66279444354677],[-111.90779450037459,33.662495783621765],
        [-111.9065129642833,33.66199801477579]
      ]}},
      {"type":"Feature","properties":{"name":"New Azure Aprtments","desc":"Estimated Delivery in Q4 2027"},"geometry":{"type":"Point","coordinates":[-111.96520199908622,33.67437735017711]}},
      {"type":"Feature","properties":{"name":"Cavasson East","desc":"18700 N Hayden Road"},"geometry":{"type":"Point","coordinates":[-111.90919129839082,33.65605347993039]}},
      {"type":"Feature","properties":{"name":"Hilton Hotel","desc":""},"geometry":{"type":"Point","coordinates":[-111.90869501725943,33.658382402589154]}},
      {"type":"Feature","properties":{"name":"Axis Raintree","desc":"8605 E Raintree Dr"},"geometry":{"type":"Point","coordinates":[-111.89428796152342,33.617995783187396]}},
      {"type":"Feature","properties":{"name":"Mack Innovation Park","desc":"Toy Barn is moving forward with a 10-acre, 205,000-square-foot site at Mack Innovation Park, where it plans to start construction in winter 2025 on a high-end garage condo project."},"geometry":{"type":"Point","coordinates":[-111.88906127197775,33.64408980520355]}},
      {"type":"Feature","properties":{"name":"Mayo Clinic","desc":""},"geometry":{"type":"Point","coordinates":[-111.94957321268495,33.66174827458897]}},
      {"type":"Feature","properties":{"name":"The Loop","desc":"17799 N 85th St <p>Expected to complete in late 2026.</p>"},"geometry":{"type":"Point","coordinates":[-111.89639994604005,33.64853559679908]}},
      {"type":"Feature","properties":{"name":"Axon's campus","desc":"Thanks to Senate Bill 1543, Axon can add 1,900 housing units and a hotel to its light-industrial site without going through a citywide referendum, but the Scottsdale City Council is now considering suing the state."},"geometry":{"type":"Polygon","coordinates":[[
        [-111.90772501280922,33.65383719802263],[-111.9076148874206,33.649757854377214],
        [-111.90258582799805,33.64962034504343],[-111.90175988758205,33.64968146033003],
        [-111.90076875908274,33.649925921043035],[-111.89964915096304,33.65036900431515],
        [-111.89882320983929,33.65075097075491],[-111.89847447944166,33.650934314076764],
        [-111.89994281795899,33.6518815816832],[-111.90170482417999,33.652599664695515],
        [-111.90273266114215,33.65299689953268],[-111.90410922850229,33.653271907192234],
        [-111.90585288056594,33.65359274829083],[-111.90772501280922,33.65383719802263]
      ]]}},
      {"type":"Feature","properties":{"name":"Mortenson","desc":""},"geometry":{"type":"Polygon","coordinates":[[
        [-111.92569556664311,33.65902997803397],[-111.92555215338824,33.66974582626531],
        [-111.93407636600512,33.669755811337936],[-111.93389025869571,33.6647949617051],
        [-111.93505452106405,33.66363219346202],[-111.93524081539535,33.66305079909522],
        [-111.9351498824249,33.66141578471746],[-111.93501018914708,33.66098941043644],
        [-111.93324055771974,33.660252940899284],[-111.93058608562814,33.65978780403353],
        [-111.92569556664311,33.65902997803397]
      ]]}},
      {"type":"Feature","properties":{"name":"LGE's warehouse","desc":"7501 E Redfield Rd"},"geometry":{"type":"Point","coordinates":[-111.9201396183087,33.610817399406926]}},
      {"type":"Feature","properties":{"name":"The Parque","desc":""},"geometry":{"type":"Polygon","coordinates":[[
        [-111.92521331470705,33.63290867974972],[-111.92521331470705,33.62945502549688],
        [-111.92211565737337,33.62945502549688],[-111.92211565737337,33.63290867974972],
        [-111.92521331470705,33.63290867974972]
      ]]}},
      {"type":"Feature","properties":{"name":"ASM","desc":""},"geometry":{"type":"Polygon","coordinates":[[
        [-111.92098694796891,33.656665993041145],[-111.92094448866835,33.6551933972068],
        [-111.92168044987741,33.6551933972068],[-111.91713730472026,33.65396817826699],
        [-111.91679763031566,33.65506380756612],[-111.91645795591161,33.655747096196436],
        [-111.91676932411546,33.655817780917516],[-111.91681178341602,33.65597093094755],
        [-111.91760435702604,33.656135861443545],[-111.91761851012642,33.65602983473245],
        [-111.92098694796891,33.656665993041145]
      ]]}},
      {"type":"Feature","properties":{"name":"Banner Health","desc":""},"geometry":{"type":"Point","coordinates":[-111.91334406719191,33.65385238518452]}},
      {"type":"Feature","properties":{"name":"Trace Line","desc":"Example line"},"geometry":{"type":"LineString","coordinates":[
        [-111.91609045341866,33.65579013247327],[-111.91684832680632,33.653812668471716],
        [-111.91518683514872,33.6529755687956],[-111.91391885467324,33.652441761851804],
        [-111.91307353435614,33.652029272400156],[-111.91176183041621,33.651495459587224],
        [-111.91093108458728,33.65134987369986],[-111.91026065812903,33.65122855193826],
        [-111.91017321119962,33.651871555322444],[-111.90996916838054,33.65204140447722],
        [-111.90970682759256,33.65232044163626],[-111.90961938066316,33.652526685911454],
        [-111.90954650822216,33.652684401788704],[-111.90951735924558,33.654079568112834],
        [-111.91138289373832,33.6545769697684],[-111.9114120427149,33.654771076951434],
        [-111.91323385374264,33.65512289510515],[-111.91505566477065,33.65551110657074],
        [-111.91498279232965,33.655656685419046],[-111.91604672997003,33.655887184757745],
        [-111.91609045341866,33.65579013247327]
      ]}},
      {"type":"Feature","properties":{"name":"Silverleaf Auto Garages","desc":"Located at 9271 E Hidden Spur Trail within DC Ranch Corporate Center..."},"geometry":{"type":"Point","coordinates":[-111.88159818069133,33.64407871950708]}},
      {
      "type": "Feature",
      "properties": {"name":"Scottsdale Quarter","desc":"Scottsdale Quarter, a 755,000-square-foot mixed-use center with retail, dining, office, and nearly 600 residential units, was acquired by FalconEye Ventures for $645.1 million. The new owner, founded by billionaire George Kurtz, plans to invest $100 million in upgrades, with local operator Vestar managing the property."},
      "geometry": {
        "coordinates": [
          [
            [
              -111.9253621110699,
              33.625695561322146
            ],
            [
              -111.9254864846587,
              33.62283590418906
            ],
            [
              -111.9222134215883,
              33.622772520872275
            ],
            [
              -111.92215421889725,
              33.62476555174362
            ],
            [
              -111.92212038878787,
              33.62555430034463
            ],
            [
              -111.92228108180676,
              33.626202195579495
            ],
            [
              -111.92279948029322,
              33.626061762982005
            ],
            [
              -111.9237974685169,
              33.6258011965738
            ],
            [
              -111.92452481586575,
              33.6257026036764
            ],
            [
              -111.9253621110699,
              33.625695561322146
            ]
          ]
        ],
        "type": "Polygon"
      }
    },
     {
      "type": "Feature",
      "properties": {"name":"One Scottsdale Medical","desc":"Total Building Area: ±101,136 SF. Construction Completed 2024. Site Area: 6.52 Acres."},
      "geometry": {
        "coordinates": [-111.92416429102643, 
          33.66922179196561
        ],
        "type": "Point"
      }
    },
    
    {
      "type": "Feature",
      "properties": {"name":"One Scottsdale","desc":"One Scottsdale is a 120-acre mixed-use development located at the intersection of Loop 101 and Scottsdale Road in North Scottsdale. It plans for about 2,000 residential units, 400 hotel rooms, and roughly 2.86 million square feet of total space."},
      "geometry": {
        "coordinates": [
          [
            [
              -111.92516083443098,
              33.66971374789209
            ],
            [
              -111.92530558947522,
              33.658810341476254
            ],
            [
              -111.92105944151484,
              33.65796692649697
            ],
            [
              -111.92105944151484,
              33.66971374789209
            ],
            [
              -111.92516083443098,
              33.66971374789209
            ]
          ]
        ],
        "type": "Polygon"
      }
    },
     {
      "type": "Feature",
      "properties": {
        "name": "New Sunela Apartments",
        "desc": "Opened in 2024"
      },
      "geometry": {
        "coordinates": [
          -111.96318556455451,
          33.67314123269067
        ],
        "type": "Point"
      }
    },
    {
      "type": "Feature",
      "properties": {"name": "New Greystar Apartments",
        "desc": "Delivering Q1 2026"},
      "geometry": {
        "coordinates": [
          -111.96343776621,
          33.67403801271276
        ],
        "type": "Point"
      }
    }
    ]};
    sitesFC_cache = sitesFC;

    // add source & layers (use braces for if/else)
    if (!map.getSource("sites")) {
      map.addSource("sites", { type:"geojson", data:sitesFC });
    } else {
      map.getSource("sites").setData(sitesFC);
    }

    if (!map.getLayer("sites-fill")) {
      map.addLayer({ id:"sites-fill", type:"fill", source:"sites",
        filter:["==",["geometry-type"],"Polygon"],
        paint:{ "fill-color":"#25408f", "fill-opacity":0.35 } });
    }
    if (!map.getLayer("sites-outline")) {
      map.addLayer({ id:"sites-outline", type:"line", source:"sites",
        filter:["==",["geometry-type"],"Polygon"],
        paint:{ "line-color":"#ed1b34", "line-width":2 } });
    }
    if (!map.getLayer("sites-lines")) {
      map.addLayer({ id:"sites-lines", type:"line", source:"sites",
        filter:["==",["geometry-type"],"LineString"],
        layout:{ "line-join":"round", "line-cap":"round" },
        paint:{ "line-color":"#ed1b34", "line-width":3 } });
    }

    // Point markers
    var pointFeatures = [];
    for (i=0;i<sitesFC.features.length;i++){
      if (sitesFC.features[i].geometry && sitesFC.features[i].geometry.type==="Point"){
        pointFeatures.push(sitesFC.features[i]);
      }
    }
    for (i=0;i<pointFeatures.length;i++){
      (function(f){
        var root=document.createElement("div"); root.className="poi-marker";
        var dot=document.createElement("div"); dot.className="poi-dot"; root.appendChild(dot);

        var key=(f.properties && f.properties.name ? f.properties.name : "").toLowerCase().trim();
        dotsByKey[key]=dot;

        var lngLat=f.geometry.coordinates;
        var nm=(f.properties && f.properties.name)?f.properties.name:"Site";
        var ds=(f.properties && f.properties.desc)?f.properties.desc:"";
        var html="<strong>"+nm+"</strong><br>"+ds;

        root.addEventListener("mouseenter", function(){ showHoverPopup(lngLat, html); });
        root.addEventListener("mouseleave", hideHoverPopup);

        new mapboxgl.Marker(root).setLngLat(lngLat).addTo(map);

        if (key==="mayo clinic" || key==="banner health" || key==="one scottsdale medical"){ dot.classList.add("blue"); }
      })(pointFeatures[i]);
    }

    // Polygon hover popups
    map.on("mousemove","sites-fill",function(e){
      map.getCanvas().style.cursor="pointer";
      var f=e.features[0];
      var nm=(f.properties && f.properties.name)?f.properties.name:"Site";
      var ds=(f.properties && f.properties.desc)?f.properties.desc:"";
      showHoverPopup(e.lngLat,"<strong>"+nm+"</strong><br>"+ds);
    });
    map.on("mouseleave","sites-fill",function(){ map.getCanvas().style.cursor=""; hideHoverPopup(); });

    // Scrollama
    var scroller = scrollama();
    function setMayoBannerCircled(on){
      var keys=["mayo clinic","banner health"], k, d;
      for(k=0;k<keys.length;k++){ d=dotsByKey[keys[k]];
        if(d){ if(on){ d.classList.add("circled"); } else { d.classList.remove("circled"); } }
      }
    }

    var all = config.chapters[config.chapters.length - 1].id;


    scroller.setup({ step:".step", offset:0.5, progress:true })
      .onStepEnter(function(resp){
        var j, idx=-1;
        for(j=0;j<config.chapters.length;j++){ if(config.chapters[j].id===resp.element.id){ idx=j; break; } }
        var chapter=config.chapters[idx];

        resp.element.classList.add("active");
        var loc=resolveChapterLocation(chapter);
        var anim=chapter.mapAnimation||"flyTo";
        map[anim](loc);

        if (config.inset && insetMap){
          if (loc.zoom<5){ insetMap.flyTo({ center:loc.center, zoom:0 }); }
          else { insetMap.flyTo({ center:loc.center, zoom:3 }); }
        }
        if (config.showMarkers && marker){ marker.setLngLat(loc.center); }
        if (chapter.onChapterEnter && chapter.onChapterEnter.length>0){ for(j=0;j<chapter.onChapterEnter.length;j++){ setLayerOpacity(chapter.onChapterEnter[j]); } }
        if (chapter.callback && window[chapter.callback]){ window[chapter.callback](); }

        if (resp.element.id==="mayo"){
          setFocusCircles([
            [-111.94957321268495,33.66174827458897],
            [-111.91334406719191,33.65385238518452]
          ]);
          setMayoBannerCircled(true);
        } else {
          hideFocusCircles();
          setMayoBannerCircled(false);
        }

        if (!didInitialMobileFit && isMobile() && sitesFC_cache){
          var bbox=computeAllSitesBounds(sitesFC_cache);
          if (bbox){ didInitialMobileFit=true; map.fitBounds(bbox,{ padding:{top:40,bottom:40,left:32,right:32}, duration:600 }); }
        }


// In onStepEnter:
if (chapter.id === all) {
  setMapInteractive(true);   // only last chapter is interactive
} else {
  setMapInteractive(false);
}


      })
      .onStepExit(function(resp){
        var j, chapter=null;
        for(j=0;j<config.chapters.length;j++){ if(config.chapters[j].id===resp.element.id){ chapter=config.chapters[j]; break; } }
        resp.element.classList.remove("active");
        if (chapter && chapter.onChapterExit && chapter.onChapterExit.length>0){
          for(j=0;j<chapter.onChapterExit.length;j++){ setLayerOpacity(chapter.onChapterExit[j]); }
        }
        if (resp.element.id==="mayo"){ hideFocusCircles(); setMayoBannerCircled(false); }

        if (resp.element.id === all) {
  setMapInteractive(false);  // lock again when leaving last
}
      });

    if (config.auto){
      var firstStep=document.querySelectorAll('[data-scrollama-index="0"]');
      if (firstStep.length){ firstStep[0].scrollIntoView(); }
    }
  }); // end map.load

  // Inset helpers (simplified)
  function getInsetBounds(){
    var b=map.getBounds();
    var poly=[
      [b._sw.lng, b._sw.lat],
      [b._ne.lng, b._sw.lat],
      [b._ne.lng, b._ne.lat],
      [b._sw.lng, b._ne.lat],
      [b._sw.lng, b._sw.lat]
    ];
    var gj={ type:"FeatureCollection", features:[{ type:"Feature", properties:{}, geometry:{ type:"Polygon", coordinates:[poly] } }] };
    if (initLoad){ addInsetLayer(gj); initLoad=false; } else { updateInsetLayer(gj); }
  }
  function addInsetLayer(bounds){
    if (!insetMap){ return; }
    insetMap.addSource("boundsSource",{ type:"geojson", data:bounds });
    insetMap.addLayer({ id:"boundsLayer", type:"fill", source:"boundsSource", layout:{}, paint:{ "fill-color":"#fff","fill-opacity":0.2 } });
    insetMap.addLayer({ id:"outlineLayer", type:"line", source:"boundsSource", layout:{}, paint:{ "line-color":"#000","line-width":1 } });
  }
  function updateInsetLayer(bounds){
    if (!insetMap){ return; }
    insetMap.getSource("boundsSource").setData(bounds);
  }

  // Resize: reflow scrollama and re-fly active chapter with responsive camera
  window.addEventListener("resize", function(){
    try{ if (window.scroller && typeof window.scroller.resize==="function"){ window.scroller.resize(); } }catch(e){}
    var active=document.querySelector(".step.active");
    if(!active) return;
    var k, chap=null;
    for(k=0;k<config.chapters.length;k++){ if(config.chapters[k].id===active.id){ chap=config.chapters[k]; break; } }
    if(!chap) return;
    map.flyTo( resolveChapterLocation(chap) );
  });
  </script>
</body>
</html>
